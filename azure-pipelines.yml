pr:
  - master

jobs:
- job: Build_Windows_X86_Release
  variables:
    WORKING_DIR: 'build.x86'
  timeoutInMinutes: 180
  pool:
    vmImage: vs2017-win2016
  steps:
    - checkout: self
    - task: CMake@1
      inputs:
        workingDirectory: '$(WORKING_DIR)'
        cmakeArgs: '-DLLVM_ENABLE_PROJECTS=clang;clang-tools-extra -G "Visual Studio 15 2017" -A Win32 -Thost=x64 ..\\llvm'
    - task: VSBuild@1
      inputs:
        solution: '$(WORKING_DIR)\\tools\\clang\\tools\\extra\\clang-tidy\\tool\\clang-tidy.vcxproj'
        vsVersion: 15.0
        platform: Win32
        configuration: Release
        maximumCpuCount: true
        msbuildArchitecture: x64
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(WORKING_DIR)\\Release\\bin\\clang-tidy.exe'
        includeRootFolder: false
        archiveType: '7z'
        archiveFile: '$(WORKING_DIR)\\Release\\bin\\clang-tidy.x86.7z'
        replaceExistingArchive: true
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(WORKING_DIR)\\Release\\bin\\clang-tidy.x86.7z'
        artifactName: 'clang-tidy.x86'
- job: Build_Windows_X64_Release
  variables:
    WORKING_DIR: 'build.x64'
  timeoutInMinutes: 180
  pool:
    vmImage: vs2017-win2016
  steps:
    - checkout: self
    - task: CMake@1
      inputs:
        workingDirectory: $(WORKING_DIR)
        cmakeArgs: '-DLLVM_ENABLE_PROJECTS=clang;clang-tools-extra -G "Visual Studio 15 2017" -A x64 -Thost=x64 ..\\llvm'
    - task: VSBuild@1
      inputs:
        solution: '$(WORKING_DIR)\\tools\\clang\\tools\\extra\\clang-tidy\\tool\\clang-tidy.vcxproj'
        vsVersion: 15.0
        platform: x64
        configuration: Release
        clean: false
        maximumCpuCount: true
        msbuildArchitecture: x64
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(WORKING_DIR)\\Release\\bin\\clang-tidy.exe'
        includeRootFolder: false
        archiveType: '7z'
        archiveFile: '$(WORKING_DIR)\\Release\\bin\\clang-tidy.x64.7z'
        replaceExistingArchive: true
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(WORKING_DIR)\\Release\\bin\\clang-tidy.x64.7z'
        artifactName: 'clang-tidy.x64'
